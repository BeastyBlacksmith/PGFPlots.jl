\usepackage{pgfplots}
\pgfplotsset{compat=newest}
\pgfplotsset{every axis legend/.append style={%
cells={anchor=west}}
}
\usetikzlibrary{arrows}
\tikzset{>=stealth'}

% this is a patch to fix plotting of densities
\makeatletter
\newif\ifpgfplotsplothandlerhistogram@density
\pgfplotsset{
    hist/density/.is if=pgfplotsplothandlerhistogram@density,
    hist/density/.default=true,
    hist/density=false
}
\def\pgfplotsplothandlersurveyend@hist@{%
    \pgfmathfloatsubtract@{\pgfplotsplothandlerhistogram@datamax}{\pgfplotsplothandlerhistogram@datamin}%
    \let\pgfplotsplothandlerhistogram@range=\pgfmathresult
    \pgfmathfloatdivide@{\pgfplotsplothandlerhistogram@range}{\pgfplotsplothandlerhistogram@N}%
    \let\pgfplotsplothandlerhistogram@h=\pgfmathresult
    \pgfmathfloatreciprocal@{\pgfplotsplothandlerhistogram@h}%
    \let\pgfplotsplothandlerhistogram@invh=\pgfmathresult
    %
    \pgfplotsarraynewempty{pgfp@hist}%
    \pgfplotsarrayresize{pgfp@hist}{\pgfplotsplothandlerhistogram@Nfixed}%
    \pgfplotsarrayforeachungrouped{pgfp@hist}\as\pgfplots@hist@count{%
        \pgfplotsarrayset{\pgfplotsarrayforeachindex}\of{pgfp@hist}\to{0}%
    }%
    %
    \pgfplotsapplistXlet\pgfplots@hist@data=\pgfp@hist@@
    \pgfplotsapplistXnewempty\pgfp@hist@@
    \expandafter\pgfplotsplothandlersurveyend@hist@loop\pgfplots@hist@data\pgfplots@EOI
    \let\pgfplots@hist@data=\relax
    %

    % Calculate total count
    \c@pgf@counta=0
    \pgfplotsarrayforeachungrouped{pgfp@hist}\as\pgfplots@hist@count{%
        \advance\c@pgf@counta by\pgfplots@hist@count\relax
        \def\pgfplots@loc@TMPa{\pgfplotsarrayset{\pgfplotsarrayforeachindex}\of{pgfp@hist}\to}%
    }%
    \edef\pgfp@hist@totalcount{\the\c@pgf@counta}
    \ifpgfplotsplothandlerhistogram@cumulative
        \c@pgf@counta=0
        \pgfplotsarrayforeachungrouped{pgfp@hist}\as\pgfplots@hist@count{%
            \advance\c@pgf@counta by\pgfplots@hist@count\relax
            \def\pgfplots@loc@TMPa{\pgfplotsarrayset{\pgfplotsarrayforeachindex}\of{pgfp@hist}\to}%
            \ifpgfplotsplothandlerhistogram@density
                \pgfmathdivide{\the\c@pgf@counta}{\pgfp@hist@totalcount}%
                \expandafter\pgfplots@loc@TMPa\expandafter{\pgfmathresult}%
            \else
                \expandafter\pgfplots@loc@TMPa\expandafter{\the\c@pgf@counta}%
            \fi
        }%
    \fi%
    %
    %% Density histogram
    % Divide count in each bin by (totalcount*range/bins)
    \ifpgfplotsplothandlerhistogram@density
        \ifpgfplotsplothandlerhistogram@cumulative
        \else
            \pgfplotsarrayforeachungrouped{pgfp@hist}\as\pgfplots@hist@count{%
                \def\pgfplots@loc@TMPa{\pgfplotsarrayset{\pgfplotsarrayforeachindex}\of{pgfp@hist}\to}%
                \pgfmathdivide{\pgfplots@hist@count}{\pgfp@hist@totalcount}
                \pgfmathdivide{\pgfmathresult}{\pgfplotsplothandlerhistogram@h}
                \expandafter\pgfplots@loc@TMPa\expandafter{\pgfmathresult}%
            }%
        \fi
    \fi
    %
    %% End density histogram
    \pgfplots@curplot@threedimfalse
    %
    \pgfplotsset{/pgfplots/hist/handler}%
    \pgfplotsresetplothandler
    \tikz@plot@handler
    %
    \pgfplotsplothandlersurveystart
    %
    \let\pgfplots@current@point@z=\pgfutil@empty
    \pgfplotsarrayforeachungrouped{pgfp@hist}\as\pgfplots@hist@count{%
        \pgfplotsplothandlerhistgetintervalstartfor\pgfplotsarrayforeachindex
        \pgfplotsplothandlerhist@invtrafo
        \let\pgfplots@current@point@x\pgfmathresult%
        \let\pgfplots@current@point@y\pgfplots@hist@count%
%\message{Survey point (\pgfplots@current@point@x,\pgfplots@current@point@y)^^J}%
        \pgfplotsplothandlersurveypoint
    }%
    \ifpgfplotsplothandlerhistogram@intervals
        % replicate last count.
        \let\pgfmathresult\pgfplotsplothandlerhistogram@datamax%
        \pgfplotsplothandlerhist@invtrafo
        \let\pgfplots@current@point@x\pgfmathresult%
        \let\pgfplots@current@point@y\pgfplots@hist@count%
%\message{Survey point (\pgfplots@current@point@x,\pgfplots@current@point@y)^^J}%
        \pgfplotsplothandlersurveypoint
    \fi
    %
    \pgfplotsplothandlersurveyend
}
\makeatother